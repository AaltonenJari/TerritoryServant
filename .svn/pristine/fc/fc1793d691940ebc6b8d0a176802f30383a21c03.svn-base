<?php
if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Territory_model extends CI_Model {
    function __construct() {
        parent::__construct();
    }
    
    function search($fields, $sort_by, $sort_order, $chkbox_sel, $date_sel, $code_sel = '0', $bt_switch = '0', $date_switch = '0') 
    {
        $sort_order = ($sort_order == 'desc') ? 'desc' : 'asc';
        
        $sort_columns = array();
        foreach ($fields as $field_name => $field_display) {
            if ($field_display == "sukunimi") {
                $sort_columns[] = "name";
            } else {
                $sort_columns[] = $field_name;
            }
        }
        $sort_by = (in_array($sort_by, $sort_columns)) ? $sort_by : 'alue_code';
        
        $fetch_columns = array();
        foreach ($fields as $field_name => $field_display) {
            $fetch_columns[] = $field_name;
        }
        
        // Results query
        $query = $this->db->select($fetch_columns)
            ->from('alue');
        
        $this->db->join('(SELECT ee2.event_alue, event_user, ee2.event_date as mark_date FROM alue_events ee2 JOIN (SELECT event_alue, MAX(event_id) AS max_event_id FROM alue_events WHERE event_type = "2" GROUP BY event_alue) groupedee2 ON ee2.event_alue = groupedee2.event_alue AND ee2.event_id = groupedee2.max_event_id) e2', 'alue.alue_id = e2.event_alue','left'); 
        $this->db->join('(SELECT ee.event_alue, event_user, ee.event_date as event_last_date FROM alue_events ee JOIN (SELECT event_alue, MAX(event_id) AS max_event_id FROM alue_events GROUP BY event_alue) groupedee ON ee.event_alue = groupedee.event_alue AND ee.event_id = groupedee.max_event_id) e', 'alue.alue_id = e.event_alue','left');
        $this->db->join('person', 'e.event_user = person.person_id','left');
        
        // lainassa = false
        if ($chkbox_sel == '1') {
            $this->db->where('lainassa', '0');
        }
        
        // lainassa = true
        if ($chkbox_sel == '2') {
            $this->db->where('lainassa', '1');
        }
        
        if ($date_switch == '0') {
            $srchDate = ""; // today
        } else {
            //Circuit week starting date
            $srchDate = date_format(date_create_from_format('j.n.Y', $this->session->userdata('circuit_week_start')), 'Y-m-d');
        }
        
        // mark_date < 12 monhts
        if ($date_sel == '1') {
            $date_12_months = strtotime($srchDate ." -12 months");
            $limit_date = date ('Y-m-d' , $date_12_months);
            $this->db->where('mark_date <=', $limit_date);
        }
        // mark_date < 4 monhts
        if ($date_sel == '2') {
            $date_4_months = strtotime($srchDate ." -4 months");
            $limit_date = date ('Y-m-d' , $date_4_months);
            $this->db->where('mark_date <=', $limit_date);
        }
        
        // mark_date < 6 monhts
        if ($date_sel == '3') {
            $date_6_months = strtotime($srchDate ." -6 months");
            $limit_date = date ('Y-m-d' , $date_6_months);
            $this->db->where('mark_date <=', $limit_date);
        }
        
        // Onko rajattu alueryhm채n mukaan?
        if ($code_sel != '0') {
            $this->db->like('alue_code', $code_sel);
        }
        
        //Otetaanko liikealueet mukaan?
        if ($bt_switch == '0') {
            $this->db->not_like('alue_code', 'L');
        }
        
        //J채rjestys
        switch ($sort_by) {
            case "alue_code":
                $query = $this->db->order_by("alue_id", $sort_order);
                break;
                
            case "alue_detail":
                $query = $this->db->order_by($sort_by, $sort_order);
                $query = $this->db->order_by("alue_id", "ASC");
                break;
                
            case "alue_location":
                $query = $this->db->order_by($sort_by, $sort_order);
                $query = $this->db->order_by("alue_id", "ASC");
                break;
                
            case "lainassa":
                $query = $this->db->order_by($sort_by, $sort_order);
                $query = $this->db->order_by("mark_date", "ASC");
                $query = $this->db->order_by("alue_id", "ASC");
                break;
                
            case "mark_date":
                $query = $this->db->order_by($sort_by, $sort_order);
                $query = $this->db->order_by("alue_id", "ASC");
                break;
                
            case "event_last_date":
                $query = $this->db->order_by("lainassa", "DESC");
                $query = $this->db->order_by($sort_by, $sort_order);
                $query = $this->db->order_by("alue_id", "ASC");
                break;
                
            case "name":
                $this->db->order_by("lainassa", "DESC");
                $this->db->order_by("person_lastname", $sort_order);
                $this->db->order_by("person_name", $sort_order);
                $this->db->order_by("alue_id", "ASC");
                break;
                
            default:
                $query = $this->db->order_by("alue_id", $sort_order);
                break;
        } // switch
        
        
        $ret['rows'] = $query->get()->result();
        
        //count query
        $ret['num_rows'] = count($ret['rows']);
        
        return $ret;
    }
    
    function getTerritoryCount($chkbox_sel, $date_sel, $code_sel = '0', $bt_switch = '0', $date_switch = '0') 
	{
		$query = $this->db->select('COUNT(*) as count', FALSE)
            ->from('alue');

        $this->db->join('(SELECT ee2.event_alue, event_user, ee2.event_date as mark_date FROM alue_events ee2 JOIN (SELECT event_alue, MAX(event_id) AS max_event_id FROM alue_events WHERE event_type = "2" GROUP BY event_alue) groupedee2 ON ee2.event_alue = groupedee2.event_alue AND ee2.event_id = groupedee2.max_event_id) e2', 'alue.alue_id = e2.event_alue','left');
        $this->db->join('(SELECT ee.event_alue, event_user, ee.event_date as event_last_date FROM alue_events ee JOIN (SELECT event_alue, MAX(event_id) AS max_event_id FROM alue_events GROUP BY event_alue) groupedee ON ee.event_alue = groupedee.event_alue AND ee.event_id = groupedee.max_event_id) e', 'alue.alue_id = e.event_alue','left');
        $this->db->join('person', 'e.event_user = person.person_id','left');
            
        // lainassa = false
		if ($chkbox_sel == '1') {
            $this->db->where('lainassa', '0');
        }
        
        // lainassa = true
        if ($chkbox_sel == '2') {
            $this->db->where('lainassa', '1');
        }
        
        if ($date_switch == '0') {
            $srchDate = ""; // today
        } else {
            //Circuit week starting date
            $srchDate = date_format(date_create_from_format('j.n.Y', $this->session->userdata('circuit_week_start')), 'Y-m-d');
        }
        
        // mark_date < 12 monhts
        if ($date_sel == '1') {
            $date_12_months = strtotime($srchDate ." -12 months");
            $limit_date = date ('Y-m-d' , $date_12_months);
            $this->db->where('mark_date <=', $limit_date);
        }
        // mark_date < 4 monhts
        if ($date_sel == '2') {
            $date_4_months = strtotime($srchDate ." -4 months");
            $limit_date = date ('Y-m-d' , $date_4_months);
            $this->db->where('mark_date <=', $limit_date);
        }
        
        // mark_date < 6 monhts
        if ($date_sel == '3') {
            $date_6_months = strtotime($srchDate ." -6 months");
            $limit_date = date ('Y-m-d' , $date_6_months);
            $this->db->where('mark_date <=', $limit_date);
        }

        // Onko rajattu alueryhm채n mukaan?
        if ($code_sel != '0') {
            $this->db->like('alue_code', $code_sel);
        }
        
        //Otetaanko liikealueet mukaan?
        if ($bt_switch == '0') {
            $this->db->not_like('alue_code', 'L');
        }
        
        $res2 = $query->get()->result();
        return ($res2[0]->count);
	}
	
	function search_mark_exhort($fields, $date_switch = '0')
	{
	    $fetch_columns = array();
	    foreach ($fields as $field_name => $field_display) {
	        $fetch_columns[] = $field_name;
	    }
	    
	    // Results query
	    $query = $this->db->select($fetch_columns)
	    ->from('alue');
	    
	    $this->db->join('(SELECT ee2.event_alue, event_user, ee2.event_date as mark_date FROM alue_events ee2 JOIN (SELECT event_alue, MAX(event_id) AS max_event_id FROM alue_events WHERE event_type = "2" GROUP BY event_alue) groupedee2 ON ee2.event_alue = groupedee2.event_alue AND ee2.event_id = groupedee2.max_event_id) e2', 'alue.alue_id = e2.event_alue','left');
	    $this->db->join('(SELECT ee.event_alue, event_user, ee.event_date as event_last_date FROM alue_events ee JOIN (SELECT event_alue, MAX(event_id) AS max_event_id FROM alue_events GROUP BY event_alue) groupedee ON ee.event_alue = groupedee.event_alue AND ee.event_id = groupedee.max_event_id) e', 'alue.alue_id = e.event_alue','left');
	    $this->db->join('person', 'e.event_user = person.person_id','left');
	    
	    if ($date_switch == '0') {
	        $srchDate = ""; // today
	    } else {
	        //Circuit week starting date
	        $srchDate = date_format(date_create_from_format('j.n.Y', $this->session->userdata('circuit_week_start')), 'Y-m-d');
	    }
	    
	    $this->db->group_start(); // Open bracket
	    
	    // mark_date < 4 monhts
	    $date_4_months = strtotime($srchDate ." -4 months");
	    $limit_date_4_months = date ('Y-m-d' , $date_4_months);
	    $this->db->where('mark_date <=', $limit_date_4_months);
	    
	    // mark_date < 12 monhts
	    $date_12_months = strtotime($srchDate ." -12 months");
	    $limit_date_12_months = date ('Y-m-d' , $date_12_months);
	    $this->db->or_where('mark_date <=', $limit_date_12_months);

	    $this->db->group_end(); // Close bracket
	    
	    // lainassa = true
	    $this->db->where('lainassa', '1');
	    
	    //J채rjestys
	    $query = $this->db->order_by("person_lastname", "ASC");
	    $query = $this->db->order_by("person_name", "ASC");
	    $query = $this->db->order_by("alue_id", "ASC");
	    
	    $ret['rows'] = $query->get()->result();
	    
	    //count query
	    $ret['num_rows'] = count($ret['rows']);
	    
	    return $ret;
	}
	
	
	function get_borrowing_congs() 
	{
	    $query = $this->db->select('person_lastname, count(person_lastname) AS territory_count', FALSE)
	    ->from('alue');
	    $this->db->join('(SELECT ee.event_alue, event_user, ee.event_date FROM alue_events ee JOIN (SELECT event_alue, MAX(event_id) AS max_event_id FROM alue_events GROUP BY event_alue) groupedee ON ee.event_alue = groupedee.event_alue AND ee.event_id = groupedee.max_event_id) e', 'alue.alue_id = e.event_alue');
	    $this->db->join('person', 'e.event_user = person.person_id');

	    // lainassa = true
	    $this->db->where('lainassa', '1');

	    $this->db->where('person_name', 'srk');
	    
	    $this->db->group_by('person_lastname'); 
	    $this->db->order_by('person_lastname', 'ASC');
	
	    $ret['rows'] = $query->get()->result();
	    
	    return $ret;
	}
	
	function get_terr_group_count($code)
	{
	    //count query
	    $query = $this->db->select('COUNT(*) as count', FALSE)
	    ->from('alue')
	    ->like('alue_code', $code);
	    
	    $res = $query->get()->result();
	    return ($res[0]->count);
	}
	
	
	function get_alue_row($columns, $alue_numero) 
	{
	    // Results query
	    $query = $this->db->select($columns)
	    ->from('alue');
	    
	    $this->db->join('(SELECT ee.event_alue, event_user, ee.event_date as mark_date FROM alue_events ee JOIN (SELECT event_alue, MAX(event_id) AS max_event_id FROM alue_events GROUP BY event_alue) groupedee ON ee.event_alue = groupedee.event_alue AND ee.event_id = groupedee.max_event_id) e', 'alue.alue_id = e.event_alue','left');
	    $this->db->join('person', 'e.event_user = person.person_id','left');
	    
	    $this->db->where('alue_code', $alue_numero);
	        
	    $result_array = $this->db->get()->result_array();
	    
	    return $result_array[0];
	}
	
	function get_name_id($first_name, $last_name) 
	{
	    $name_id = -1;
	    // Results query
	    $query = $this->db->select('person_id')
	    ->from('person');
	    
	    $this->db->where('person_name', $first_name);
	    $this->db->where('person_lastname', $last_name);
	    
	    $result_array = $this->db->get()->result_array();
	    if (!empty($result_array)) {
	        $name_id = $result_array[0]['person_id'];
	    } else {
	        $name_id = -1;
	    }
	    return $name_id;
	}
	
	function get_terr_id($terr_code)
	{
	    $terr_id = -1;
	    // Results query
	    $query = $this->db->select('alue_id')
	    ->from('alue');
	    
	    $this->db->where('alue_code', $terr_code);
	    
	    $result_array = $this->db->get()->result_array();
	    if (!empty($result_array)) {
	        $terr_id = $result_array[0]['alue_id'];
	    } else {
	        $terr_id = -1;
	    }
	    return $terr_id;
	}
	
	public function insert_person ($data) {
	    if ($this->db->insert("person", $data)) {
	        return true;
	    }
	}
	
	public function update($data, $old_terr_nbr) 
	{
	    $this->db->set($data);
	    $this->db->where("alue_code", $old_terr_nbr);
	    $this->db->update("alue", $data);
	}
}